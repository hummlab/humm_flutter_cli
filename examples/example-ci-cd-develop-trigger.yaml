# Example develop changed trigger

flutter_version: &flutter_version 3.0.0 #<- Set your flutter version.

workflows:
  create-version:
    name: Create Version
    instance_type: mac_mini_m1
    max_build_duration: 10

    environment:
      flutter: *flutter_version
      groups:
        - git

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "develop"
          include: true
          source: true

    # Add in case of mono repos
    when:
      changeset:
        includes:
          - "appName/**"

    scripts:
      - name: Check if commit is from CI/CD # To avoid loops we check if previous commit contained 'Pre-release updates', commit from humm CLI
        script: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          echo "Commit message: $COMMIT_MSG"
          echo "Commit author: $COMMIT_AUTHOR"
          if [[ "$COMMIT_MSG" == *"Pre-release updates"* ]]; then
            echo "Commit comes from CI/CD. Exiting job..."
            exit 0  # exit to prevent further execution
          fi

      - name: Download repo with SSH connection
        script: git clone git@github.com:example/app.git

      - name: Download humm CLI with SSH connection
        script: git clone git@github.com:hummlab/humm_flutter_cli.git

      - name: Setup humm CLI
        working_directory: humm_flutter_cli
        script: dart pub global activate --source path .

      # E.G. in case of mono repos, check if folder with app1 contains changes
      - name: Check Changes in App1
        working_directory: app1
        script: |
          APP1_CHANGED=$(git diff --name-only origin/develop~1 origin/develop | grep '^app1/' || true)
          if [ -n "$APP_CHANGED" ]; then
            echo "Changes detected in app1/"
            echo "Triggering app version creation"
            humm release --tag-prefix app1
          fi

      # E.G. in case of mono repos, check if folder with app2 contains changes
      - name: Check Changes in App2
        working_directory: app2
        script: |
          APP2_CHANGED=$(git diff --name-only origin/develop~1 origin/develop | grep '^app2/' || true)
          if [ -n "$PANEL_CHANGED" ]; then
            echo "Changes detected in app2/"
            echo "Triggering panel version creation"
            humm release --tag-prefix app2
          fi
